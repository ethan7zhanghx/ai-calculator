// Prisma Schema for AI Calculator (Production - PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed password
  phone     String?  @unique
  name      String?
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  evaluations Evaluation[]
  feedbacks   Feedback[]

  @@index([email])
  @@index([phone])
}

// 评估历史表
model Evaluation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 评估输入参数 (对齐当前 EvaluationRequest 接口)
  model                    String
  hardware                 String
  cardCount                Int      // 总卡数 (machineCount * cardsPerMachine)
  machineCount             Int      @default(1) // 机器数量
  cardsPerMachine          Int      @default(1) // 每机卡数
  businessDataDescription  String   @default("") @db.Text // 业务数据描述 (替代旧的 volume 和 types)
  businessDataQuality      String   @default("high") // "high" | "low"
  businessScenario         String   @default("") @db.Text // 业务场景描述
  performanceTPS           Int      @default(50) // Tokens Per Second
  performanceConcurrency   Int      @default(100) // 并发数

  // 评估结果 (JSON存储完整结果)
  resourceFeasibility  String @db.Text // JSON
  technicalFeasibility String @db.Text // JSON
  businessValue        String @db.Text // JSON

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// 反馈表
model Feedback {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 反馈类型
  type String // "module" | "general"

  // 模块反馈相关字段
  evaluationId String?
  moduleName   String? // "resource" | "technical" | "business"
  rating       String? // "positive" | "negative"

  // 通用反馈相关字段
  feedbackType String? // "bug" | "feature" | "improvement" | "other"
  title        String?
  description  String?
  contactEmail String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([evaluationId])
}
