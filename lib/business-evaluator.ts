/**
 * 商业价值评估模块
 * 使用百度千帆 ERNIE-4.5 API 进行深度商业分析
 */

import type { EvaluationRequest } from "./types"
import { fetchWithRetry } from "./api-retry"

export interface BusinessValueResult {
  score: number
  summary: string
  disclaimer: string
  dimensions: {
    problemSolutionFit: {
      score: number
      status: "strong" | "moderate" | "weak"
      analysis: string
      painPoints: string[]
      aiNecessity: "high" | "medium" | "low"
    }
    roiFeasibility: {
      score: number
      analysis: string
      considerations: string[]
    }
    competitiveAdvantage: {
      score: number
      level: "differentiated" | "parity" | "lagging"
      analysis: string
      barriers: string[]
    }
    scalability: {
      score: number
      level: "high" | "medium" | "low"
      analysis: string
      growthPotential: string[]
    }
    implementationRisk: {
      score: number
      level: "low" | "medium" | "high"
      analysis: string
      risks: {
        technical: string[]
        business: string[]
        compliance: string[]
        organizational: string[]
      }
      mitigations: string[]
    }
    marketTiming: {
      score: number
      status: "optimal" | "acceptable" | "poor"
      analysis: string
      urgency: "high" | "medium" | "low"
    }
  }
  opportunities: string[]
  risks: string[]
  recommendations: string[]
}

const SYSTEM_PROMPT = `你是一位资深的AI商业顾问，擅长评估AI项目的商业价值和投资回报。

## 评估原则

1. **客观性**：基于业务场景进行分析，不编造具体数据（如具体金额、百分比）
2. **实用性**：提供可操作的商业建议，而非空洞的理论
3. **全面性**：从多个商业维度综合评估
4. **连贯性**：用段落式叙述而非简单罗列，提供深入分析

## 评分标准

**总分范围：0-100分**

- 80-100分：极具商业价值，强烈建议投资
- 60-79分：有商业价值，可以推进但需优化
- 40-59分：商业价值存疑，需重新论证或调整方向
- 0-39分：商业价值低，不建议投入资源

## 评估维度

### 1. 问题-解决方案匹配度 (25%)
评估AI方案是否真正解决业务痛点：
- 业务场景是否存在明确的痛点？
- AI是必要手段还是过度设计？
- 是否有更简单的非AI解决方案？

### 2. ROI预期合理性 (20%)
分析投入产出比（定性分析，不编造具体数字）：
- 开发成本相对于企业规模是否合理？
- 运营成本是否可持续？
- 预期收益的实现路径是否清晰？
- 回本周期是否在可接受范围内？

### 3. 市场竞争优势 (20%)
评估差异化竞争力：
- 竞争对手的AI应用现状
- 该方案的独特性和壁垒
- 用户对该AI功能的真实需求程度

### 4. 可扩展性与增长潜力 (15%)
分析规模化能力：
- 用户增长时性能扩展性
- 是否可复用到相关业务场景
- 数据积累是否形成正向飞轮

### 5. 落地风险评估 (15%)
识别实施障碍：
- 技术风险（模型效果、数据质量）
- 业务风险（用户接受度、流程改造）
- 合规风险（数据隐私、行业监管）
- 组织风险（团队能力、协作困难）

### 6. 时间窗口与紧迫性 (5%)
判断启动时机：
- 市场需求成熟度
- 竞争态势
- 技术成熟度
- 企业资源就绪情况

## 输出要求

1. **禁止编造数据**：不要输出"节省成本70%"、"ROI达300%"等具体数字，除非用户输入中明确提供
2. **段落式分析**：每个维度用2-4句连贯的话进行深入分析，而非简单罗列要点
3. **平衡视角**：既要指出机会，也要提示风险
4. **可操作建议**：recommendations要具体可执行，而非泛泛而谈
5. **免责声明**：必须包含免责声明，说明这是辅助决策工具

## 输出格式

严格按照JSON Schema输出，确保所有字段完整。`


// Few-Shot 示例案例
const FEW_SHOT_EXAMPLES = `
## 案例1：智能客服系统（高商业价值）

### 用户输入
业务场景：我们是一家电商平台，目前有200人的客服团队处理售前咨询、订单查询、退换货等问题。客服人力成本持续攀升，且无法提供7x24小时服务。希望引入AI客服系统，处理常见问题，人工客服专注处理复杂投诉。

模型：Llama 3 70B
硬件配置：A100 80GB * 2
数据：10000条历史客服对话记录（已脱敏）
性能需求：QPS 50，并发100

### 评估输出
\`\`\`json
{
  "score": 82,
  "summary": "该智能客服方案具有很强的商业价值。从问题匹配度来看，人工客服成本高昂、无法全天候服务是电商行业的普遍痛点，AI客服能够有效解决重复性咨询问题。从ROI角度分析，虽然初期需要投入硬件采购和人才招聘的成本，但考虑到客服人力成本的持续性和AI系统自持运营的边际成本递减特性，长期来看投入产出比较为可观。竞争优势方面，通过私有化部署开源模型，企业能将核心对话数据保留在内部，形成独特的竞争壁垒。该方案具备良好的可扩展性，后续可延伸至售前导购、智能推荐等场景，形成数据和服务能力的正向循环。主要风险在于私有化部署的技术复杂度和前期较高的固定资产投入，建议采用人机协同模式并分阶段灰度发布以降低风险。",
  "disclaimer": "本评估基于AI模型分析生成，仅供决策参考，不构成投资建议。实际商业价值受市场环境、执行能力、技术迭代等多种因素影响，企业应结合自身情况审慎评估。建议在正式立项前进行更详细的可行性研究和ROI测算。",
  "dimensions": {
    "problemSolutionFit": {
      "score": 90,
      "status": "strong",
      "analysis": "电商客服场景存在非常明确的业务痛点。人工客服团队规模大、成本持续增长，且大量咨询属于重复性问题（如订单查询、物流跟踪、退换货政策等），这类问题完全适合由AI系统处理。更重要的是，用户对即时响应的需求与人工客服的工作时间限制之间存在矛盾，AI客服的7x24小时服务能力能够显著提升用户体验。从方案设计来看，采用人机协同模式而非完全替代人工，这种务实的定位既能发挥AI优势，又保留了人工客服处理复杂问题的能力，体现了对问题本质的深刻理解。",
      "painPoints": [
        "人工客服成本持续攀升",
        "大量重复性咨询占用人力资源",
        "无法提供全天候服务",
        "客服培训周期长、人员流动率高"
      ],
      "aiNecessity": "high"
    },
    "roiFeasibility": {
      "score": 75,
      "analysis": "私有化部署开源模型的ROI分析与使用API有本质不同。投入主要包括：一次性的高端硬件采购成本（如2张A100服务器），持续的电力和机房托管费用，以及专业的AI/MLOps工程师的人力成本。虽然初期投入显著高于API模式，但长期来看，推理成本几乎为零，且不受外部API提供商的定价策略影响。收益方面，除了直接的人力成本节约，更重要的是将核心用户对话数据保留在企业内部，这些数据是优化产品、洞察用户需求的金矿。综合来看，对于有长期AI战略和数据资产化意识的企业，私有化部署的长期ROI更高，但需要企业有更强的技术能力和前期资金投入。",
      "considerations": [
        "初期投入包括高端硬件采购、机房建设等固定资产投资",
        "运营成本包括电力、网络、以及专业的MLOps工程师人力成本",
        "收益包括人力成本节约、数据资产私有化、长期推理成本趋近于零",
        "需评估企业自身的技术实力和资金状况是否支持私有化部署",
        "建议测算硬件折旧和人力成本，与主流API服务的3年总拥有成本(TCO)进行对比"
      ]
    },
    "competitiveAdvantage": {
      "score": 85,
      "level": "differentiated",
      "analysis": "在AI客服已成为行业标配的背景下，私有化部署开源模型能构建独特的竞争优势。首先，核心优势在于数据主权和隐私保护。所有用户对话数据都保留在企业内部，避免了将敏感数据上传给第三方API服务商的风险，这对于重视用户隐私的品牌来说是巨大的加分项。其次，基于私有数据微调的模型能够更深度地理解企业独特的业务逻辑和用户话术，形成真正'懂你'的AI客服，这是通用API难以比拟的。最后，不受制于人的技术路线让企业在功能迭代和模型优化上拥有完全的自主权，可以更快地响应市场变化。",
      "barriers": [
        "数据资产的完全私有化和安全可控",
        "基于自有数据深度定制的模型效果",
        "不受制于第三方API提供商的技术自主权",
        "长期来看更低的边际推理成本"
      ]
    },
    "scalability": {
      "score": 85,
      "level": "high",
      "analysis": "该方案具有优秀的可扩展性。从技术角度看，一旦搭建起私有化推理平台，增加新的AI应用（如内部知识库、代码助手）的边际硬件成本较低。从业务角度看，客服系统的底层能力（自然语言理解、知识问答、多轮对话等）可以平滑迁移到其他场景，如售前导购、商品推荐、用户调研等，实现能力的复用和价值的放大。更重要的是，随着系统运行，会持续积累用户咨询数据、问题反馈、知识库更新等，这些数据可以用于模型迭代优化，形成'数据越多-模型越好-用户越多-数据越多'的正向飞轮。因此，该项目不应被视为单点的成本优化工具，而应视为可持续增长的数字化能力平台。",
      "growthPotential": [
        "横向扩展到售前咨询、导购推荐、用户调研等场景",
        "纵向深化到智能质检、情绪分析、用户画像等高级功能",
        "数据飞轮效应：使用越多，模型越准，体验越好",
        "能力沉淀为企业级对话AI平台，支撑多业务线"
      ]
    },
    "implementationRisk": {
      "score": 65,
      "level": "medium",
      "analysis": "私有化部署的风险与API模式不同，更偏向于技术和运维。技术层面，最大的风险在于开源模型的部署、优化和维护需要专业的AI/MLOps团队，这对许多传统企业来说是新的挑战。硬件采购周期、服务器稳定性、网络配置等都可能成为项目延期的原因。业务层面，用户对AI客服的接受度存在不确定性，部分用户可能更倾向于人工服务，需要在产品设计中提供便捷的转人工通道。组织层面，AI客服的引入可能引发现有客服团队的焦虑和抵触，需要提前做好沟通和转型安排，将其定位为'能力增强'而非'人员替代'。",
      "risks": {
        "technical": [
          "缺乏专业的AI/MLOps团队来部署和维护模型",
          "硬件采购周期长，服务器配置和优化复杂",
          "开源模型推理性能优化（如量化、剪枝）的技术门槛高",
          "系统稳定性和高可用性保障难度大"
        ],
        "business": [
          "用户对AI客服的接受度和满意度不确定",
          "现有业务流程改造的复杂度和阻力"
        ],
        "compliance": [
          "私有化部署能更好地满足数据合规要求，此项风险较低"
        ],
        "organizational": [
          "客服团队对AI系统的抵触和不配合",
          "需要新建或引入AI技术团队，存在招聘和管理挑战"
        ]
      },
      "mitigations": [
        "评估并组建专业的MLOps团队，或寻求第三方咨询服务",
        "采用人机协同模式，AI处理常见问题，人工兜底复杂场景",
        "小范围灰度发布，收集用户反馈后逐步放量",
        "提前做好客服团队的培训和转型安排，强调AI是辅助而非替代"
      ]
    },
    "marketTiming": {
      "score": 80,
      "status": "optimal",
      "analysis": "当前时点启动AI客服项目的时机较为理想。从技术成熟度看，Llama 3等顶级开源模型的性能已能与闭源模型媲美，且vLLM等推理框架的成熟也大大降低了部署门槛。从市场需求看，用户对线上服务的即时响应需求持续提升。从竞争态势看，虽然多数企业在使用API构建AI客服，但通过私有化部署建立数据和技术壁垒的窗口期仍然存在。从企业资源看，拥有一定规模的客服团队和历史数据，具备了启动AI项目的基础条件。综合来看，现在启动既能享受开源技术红利，又能构建长期竞争优势。",
      "urgency": "medium"
    }
  },
  "opportunities": [
    "显著降低客服人力成本，提升运营效率",
    "实现7x24小时全天候服务，提升用户体验和满意度",
    "将核心用户对话数据资产化，构建长期竞争壁垒",
    "建立自主可控的AI能力平台，支撑未来更多业务创新"
  ],
  "risks": [
    "私有化部署的技术门槛和前期投入较高",
    "需要专业的MLOps团队进行长期维护和优化",
    "硬件采购和部署周期可能长于预期",
    "如果业务量未达预期，可能导致硬件资源闲置"
  ],
  "recommendations": [
    "进行详细的TCO（总拥有成本）分析，对比私有化部署与使用主流API服务在3年内的成本差异",
    "优先招聘或培养1-2名核心MLOps工程师，负责技术方案的落地",
    "采用人机协同模式，先从FAQ、订单查询等低风险场景切入，逐步扩大AI覆盖范围",
    "建立完善的效果监控体系，包括准确率、用户满意度、转人工率等关键指标",
    "提前规划客服团队转型方案，将其定位为'AI训练师'和'复杂问题专家'"
  ]
}
\`\`\`

---

## 案例2：OCR发票识别（中等商业价值）

### 用户输入
业务场景：我们公司每月需要处理5000张纸质发票的报销，财务人员手工录入效率低且容易出错。希望用OCR技术自动识别发票信息，提升财务效率。

模型：Qwen-VL-Max (多模态)
硬件配置：RTX 4090 * 1
数据：2000张发票图片样本
性能需求：QPS 10

### 评估输出
\`\`\`json
{
  "score": 58,
  "summary": "该OCR发票识别方案具有一定的商业价值，但存在明显的过度设计问题。从问题匹配度看，手工录入发票确实效率低且易错，存在真实的业务痛点，但使用通用的多模态大模型来解决OCR问题属于典型的'杀鸡用牛刀'。市面上已有成熟的发票OCR专用服务（如百度OCR、腾讯OCR等），价格低廉且准确率更高，完全能够满足需求。从ROI角度看，私有化部署一个多模态大模型的硬件和人力成本，远高于使用专用OCR服务，且不会带来相应的价值提升，投入产出比不合理。该方案的主要价值在于解决了真实的业务痛点，但技术选型失当导致整体商业价值大打折扣。建议调整技术方案，采用专业的OCR服务而非自部署大模型，这样可以用更低的成本和更短的开发周期达到更好的效果。",
  "disclaimer": "本评估基于AI模型分析生成，仅供决策参考，不构成投资建议。实际商业价值受市场环境、执行能力、技术迭代等多种因素影响，企业应结合自身情况审慎评估。建议在正式立项前进行更详细的可行性研究和ROI测算。",
  "dimensions": {
    "problemSolutionFit": {
      "score": 75,
      "status": "moderate",
      "analysis": "发票手工录入的痛点是真实且明确的，财务人员重复性劳动时间长、容易出错、效率低下，这在企业管理中是常见问题。OCR自动识别确实能够有效解决这一痛点。然而，问题在于技术方案的选择。Qwen-VL是一个通用的多模态大模型，其核心优势在于复杂的视觉问答和内容生成，而非结构化的文字识别。对于发票这种格式相对固定、识别需求明确的场景，专业的OCR服务（如百度OCR、腾讯OCR等）经过海量数据训练，在特定版式上的准确率、响应速度和性价比都远优于通用大模型方案。因此，虽然问题识别准确，但解决方案的适配性存在偏差。",
      "painPoints": [
        "财务人员手工录入发票效率低下",
        "人工录入容易出现数字错误和遗漏",
        "月末报销高峰期财务工作量激增",
        "纸质发票管理和归档成本高"
      ],
      "aiNecessity": "medium"
    },
    "roiFeasibility": {
      "score": 45,
      "analysis": "该方案的ROI存在明显的问题。从成本角度看，即使是使用消费级的RTX 4090，也需要承担硬件、电力和人力的成本。更重要的是，为了达到专用OCR服务的准确率，很可能需要对Qwen-VL模型进行微调，这又会带来额外的数据标注和训练成本。相比之下，专业的OCR服务按次计费，单次调用成本极低，且无需承担任何运维成本。从收益角度看，无论使用哪种技术，最终实现的业务价值（节省人工录入时间、减少错误）是相同的，但自部署大模型的TCO显著更高。因此，该方案的投入产出比不合理。",
      "considerations": [
        "自部署大模型需要承担硬件、电力、人力等长期运维成本",
        "专业OCR服务的价格通常远低于自部署方案的TCO",
        "为达到同等准确率，自部署方案可能需要额外的微调成本",
        "业务收益（节省人工时间）与技术选型无关，但成本差异大",
        "需重新评估技术方案，选择性价比更高的实现路径"
      ]
    },
    "competitiveAdvantage": {
      "score": 40,
      "level": "lagging",
      "analysis": "OCR发票识别在企业数字化转型中已经是非常成熟的应用，几乎不构成任何竞争优势。市场上存在大量成熟的解决方案，从SaaS服务到开源工具，选择丰富且价格透明。更重要的是，这属于企业内部流程优化，对外部用户和客户完全不可见，无法形成市场层面的差异化。如果说有任何潜在优势，那就是通过流程优化提升内部运营效率，间接降低成本，但这种优势是通过'做好基础设施'实现的，而非创造独特价值。使用通用大模型而非专业OCR更不会带来额外的竞争优势，反而因为成本更高而处于不利地位。",
      "barriers": [
        "该应用几乎不存在技术壁垒，市场上方案成熟",
        "属于内部流程优化，对外不可见，无法形成市场差异化"
      ]
    },
    "scalability": {
      "score": 60,
      "level": "medium",
      "analysis": "该方案的可扩展性中等。从业务量角度看，如果未来发票数量增长，OCR系统可以线性扩展。从应用范围看，OCR能力可以扩展到其他文档识别场景，如合同、证照、单据等，具有一定的复用价值。然而，OCR本质上是一个相对独立的功能模块，与企业核心业务的深度整合有限，不太可能形成显著的网络效应或数据飞轮。此外，随着电子发票的普及，纸质发票的处理需求可能逐渐下降，这在一定程度上限制了该方案的长期增长空间。",
      "growthPotential": [
        "可扩展到其他文档识别场景（合同、证照、单据等）",
        "支持发票量级增长的线性扩展",
        "但长期看电子发票普及可能降低OCR需求"
      ]
    },
    "implementationRisk": {
      "score": 75,
      "level": "low",
      "analysis": "该项目的实施风险相对较低。技术层面，OCR是相对成熟的技术，尤其是发票这种格式相对标准化的文档，识别准确率通常较高，技术风险可控。业务层面，发票识别是纯粹的效率提升工具，不涉及业务流程的重大变革，财务人员的接受度预计较高。合规层面，发票数据处理需要注意信息安全和隐私保护，但只要选择可靠的服务商并做好数据脱敏，风险可控。组织层面，该项目规模较小，涉及部门有限，协调成本低。",
      "risks": {
        "technical": [
          "通用多模态模型在特定版式上的准确率可能不如专用OCR模型",
          "图像质量差（模糊、折痕）时准确率下降"
        ],
        "business": [
          "财务人员需要适应新流程，存在短期学习成本"
        ],
        "compliance": [
          "发票数据涉及企业财务信息，需确保数据安全"
        ],
        "organizational": [
          "项目规模小，组织风险低"
        ]
      },
      "mitigations": [
        "优先选择识别准确率高的成熟OCR服务商",
        "建立人工复核机制，对识别结果进行抽查",
        "与IT和安全部门合作，确保数据传输和存储的安全性"
      ]
    },
    "marketTiming": {
      "score": 50,
      "status": "acceptable",
      "analysis": "从时机角度看，现在启动发票OCR项目算不上最优但也可以接受。一方面，OCR技术已经非常成熟，市场上有大量现成方案可供选择，技术风险低，随时可以启动。另一方面，电子发票正在快速普及，国家也在推动发票电子化，未来纸质发票的占比可能持续下降，这意味着该项目的生命周期和价值回报期可能有限。因此，如果当前纸质发票处理确实是一个显著的痛点，现在启动项目可以立即获得收益；但如果痛点不够明显，也可以考虑等待电子发票更普及后，直接通过系统对接的方式解决。",
      "urgency": "low"
    }
  },
  "opportunities": [
    "解放财务人员的重复性劳动，提升工作效率和满意度",
    "减少人工录入错误，提高财务数据准确性",
    "为财务数字化转型打下基础"
  ],
  "risks": [
    "技术选型不当（使用通用大模型而非专业OCR）导致TCO过高",
    "电子发票普及可能缩短项目价值回报期",
    "财务数据安全和隐私保护风险"
  ],
  "recommendations": [
    "强烈建议调整技术方案，使用专业的OCR SaaS服务（如百度OCR、腾讯OCR等）而非自部署大模型，大幅降低成本和技术门槛",
    "如果必须私有化部署，也应选择轻量级的、专门用于OCR的开源模型，而非通用多模态大模型",
    "建立人工复核机制，对识别结果进行抽查，确保数据准确性",
    "关注电子发票普及趋势，评估是否可通过系统对接方式更高效地解决问题"
  ]
}
\`\`\`

---

## 案例3：医疗诊断助手（高风险场景）

### 用户输入
业务场景：我们是一家互联网医疗平台，希望开发AI诊断助手，用户输入症状后，AI给出可能的疾病判断和就医建议，减轻医生工作负担。

模型：ERNIE-4.5-VL-424B-A47B-PT
硬件配置: H800 80GB * 8
数据：5000条脱敏病例数据
性能需求：QPS 20

### 评估输出
\`\`\`json
{
  "score": 35,
  "summary": "该AI诊断助手方案存在严重的商业价值和风险问题，不建议按当前思路推进。虽然减轻医生负担、提升诊疗效率是医疗行业的真实痛点，但AI直接诊断涉及极高的医疗风险和法律责任，一旦误诊可能导致严重的健康后果甚至生命危险，这不是技术问题而是根本性的伦理和法律问题。从合规角度看，医疗AI在中国受到严格监管，需要通过NMPA（国家药品监督管理局）认证，审批周期长、门槛高。从ROI角度看，即使技术可行，私有化部署顶级模型的巨额硬件投入，加上潜在的医疗纠纷和法律诉讼成本，也可能远超预期收益。更重要的是，医疗诊断是一个需要综合病史、体征、检查结果等多维信息的复杂决策过程，单纯基于症状描述的AI判断可靠性极低。建议将方案调整为'症状预筛查+导诊建议'，明确告知用户不构成诊断，由专业医生进行最终判断，这样既能提供价值又规避风险。",
  "disclaimer": "本评估基于AI模型分析生成，仅供决策参考，不构成投资建议。实际商业价值受市场环境、执行能力、技术迭代等多种因素影响，企业应结合自身情况审慎评估。建议在正式立项前进行更详细的可行性研究和ROI测算。特别提醒：医疗健康领域受到严格监管，任何涉及诊断、治疗建议的AI应用均需通过相关部门审批，切勿擅自上线。",
  "dimensions": {
    "problemSolutionFit": {
      "score": 40,
      "status": "weak",
      "analysis": "医疗资源紧张、医生工作负担重确实是真实痛点，AI辅助诊疗在理论上也有巨大的应用前景。然而，当前方案存在根本性的问题：将AI定位为'诊断助手'并'给出疾病判断'，这已经跨越了辅助工具的界限，进入了医疗决策的核心区域。医疗诊断是一个高度复杂的过程，需要综合患者的病史、家族史、体征、实验室检查、影像学检查等多维度信息，单纯基于用户自述的症状进行判断，可靠性极低且风险极高。更重要的是，这种应用场景与AI的本质能力不匹配——大语言模型擅长的是信息整合和模式识别，但医疗诊断需要的是严谨的因果推理和风险评估，两者存在本质差异。",
      "painPoints": [
        "医疗资源分布不均，基层医疗能力不足",
        "医生工作负担重，问诊时间有限",
        "患者自我诊断能力弱，常因小病跑大医院"
      ],
      "aiNecessity": "low"
    },
    "roiFeasibility": {
      "score": 20,
      "analysis": "该方案的ROI评估极不乐观。首先，从投入角度看，私有化部署顶级模型的硬件成本是天文数字（一个8卡H800服务器节点价值数百万），还需要持续的电力、运维和专业人力成本。其次，医疗AI需要通过NMPA的严格审批，这意味着大量的临床试验、数据收集、安全性验证等前期投入，周期可能长达数年。再次，从风险成本看，一旦发生误诊导致的医疗事故，潜在的法律诉讼、赔偿、品牌损害等成本可能是无限的。综合来看，该项目的风险回报比极不平衡，巨额的投入很可能无法换来合规的、可商业化的产品。",
      "considerations": [
        "私有化部署的硬件和人力成本极高",
        "NMPA审批的时间成本和资金成本极高",
        "潜在的医疗纠纷和法律诉讼风险巨大",
        "实际应用范围受限，难以充分释放商业价值",
        "需重新评估业务模式，规避高风险核心诊断环节"
      ]
    },
    "competitiveAdvantage": {
      "score": 30,
      "level": "lagging",
      "analysis": "在AI医疗诊断领域，市场上已有大量专业机构和上市公司投入巨资研发，如IBM Watson Health、阿里健康、平安好医生等，这些机构拥有海量医疗数据、专业医学团队、监管审批经验等资源优势。相比之下，一个基于通用大模型和少量病例数据的方案，在技术深度、数据积累、合规能力等方面都处于明显劣势。更重要的是，医疗AI的竞争壁垒不仅在于技术，更在于数据、专家资源、医院合作关系、监管认证等，这些都需要长期积累。因此,当前方案不仅不具备竞争优势，反而在激烈竞争的市场中处于非常不利的位置。",
      "barriers": [
        "缺乏海量高质量医疗数据",
        "缺乏专业医学团队支持",
        "缺乏监管审批经验和资源",
        "缺乏医院和医生的合作网络"
      ]
    },
    "scalability": {
      "score": 50,
      "level": "low",
      "analysis": "该方案的可扩展性受到严重限制。首先，医疗诊断属于高度专业化和地域化的服务，不同地区、不同科室、不同疾病的诊疗规范差异巨大，很难形成统一的标准化产品。其次，每个新的疾病领域、每个新的应用场景都可能需要重新进行数据收集、模型训练、临床验证、监管审批，扩展成本高昂。再次，医疗AI的网络效应有限。最后，随着规模扩大，风险也会同步放大，一旦出现系统性问题（如模型缺陷导致的批量误诊），后果不堪设想。因此，该方案的可扩展性不仅受限，而且扩展本身可能带来更大风险。",
      "growthPotential": [
        "理论上可扩展到更多疾病领域和科室",
        "但每个扩展都需要重新审批，成本高昂",
        "规模扩大带来的风险同步增加"
      ]
    },
    "implementationRisk": {
      "score": 10,
      "level": "high",
      "analysis": "该项目面临极高的实施风险，几乎每个维度都存在重大隐患。技术层面，大语言模型的幻觉问题在医疗场景中是致命的，哪怕千分之一的误诊率也可能导致严重后果。业务层面，医生和患者对AI诊断的信任度和接受度存在巨大不确定性。合规层面，这是最大的风险点——未经NMPA审批的医疗AI产品上线，本身就涉嫌违法，可能面临监管处罚；即使取得审批，后续的医疗事故责任认定、保险覆盖等法律问题也极为复杂。组织层面，该项目需要技术、医学、法律、运营等多领域专家的深度协作，协调难度极大。",
      "risks": {
        "technical": [
          "模型幻觉和误诊风险，可能导致严重健康后果",
          "5000条病例数据严重不足，模型泛化能力堪忧",
          "私有化部署顶级模型的运维复杂度和技术门槛极高"
        ],
        "business": [
          "医生和患者对AI诊断的信任度和接受度低",
          "一旦发生误诊，品牌和信誉将遭受毁灭性打击"
        ],
        "compliance": [
          "未经NMPA审批上线涉嫌违法，面临监管处罚",
          "医疗事故责任认定复杂，可能承担刑事责任",
          "数据隐私和患者信息保护要求极高"
        ],
        "organizational": [
          "缺乏专业医学团队支持",
          "技术团队对医疗领域理解不足"
        ]
      },
      "mitigations": [
        "立即调整方案定位，从'诊断助手'改为'症状预筛查+导诊建议'",
        "明确告知用户AI不提供诊断，仅供参考，最终需咨询专业医生",
        "与法律顾问合作，确保所有功能和宣传合规",
        "建立严格的免责声明和用户知情同意流程"
      ]
    },
    "marketTiming": {
      "score": 40,
      "status": "poor",
      "analysis": "从时机角度看，现在启动AI诊断项目面临多重挑战。技术层面，虽然大语言模型能力提升迅速，但在医疗诊断这种需要极高准确性和可解释性的场景中，成熟度仍然不足。监管层面，国内对医疗AI的监管日趋严格，审批要求越来越高。市场层面，虽然需求存在，但用户教育成本高，付费意愿不明确。竞争层面，大型医疗机构和科技公司已经占据先发优势。综合来看，对于资源有限的团队，当前可能不是最佳时机，建议先从低风险的健康科普、导诊建议等外围场景切入，待技术和监管环境更成熟后再考虑核心诊断功能。",
      "urgency": "low"
    }
  },
  "opportunities": [
    "如调整为导诊和健康科普，可降低风险同时提供价值",
    "积累用户健康咨询数据，为未来医疗AI应用打基础",
    "与医疗机构合作，以辅助工具定位切入市场"
  ],
  "risks": [
    "未经审批上线涉嫌违法，面临监管处罚",
    "误诊导致的医疗事故可能带来刑事责任和巨额赔偿",
    "品牌和信誉风险极高，一次事故可能导致企业倒闭",
    "私有化部署的巨额投入可能血本无归"
  ],
  "recommendations": [
    "强烈建议调整产品定位，从'AI诊断助手'改为'健康咨询和导诊助手'，仅提供科室推荐和健康科普，不涉及诊断",
    "在所有用户界面显著位置添加免责声明，明确AI建议不构成医疗诊断",
    "咨询专业医疗法律顾问，确保产品设计、功能、宣传等全面合规",
    "如确实希望进入医疗诊断领域，建议与持证医疗机构合作，由AI提供初步筛查，专业医生进行最终诊断",
    "重新评估业务模式和风险承受能力，避免在高风险领域盲目投入"
  ]
}
\`\`\`

请严格参考以上案例的风格和深度进行评估。
`

function buildBusinessPrompt(req: EvaluationRequest): string {
  const dataDescription = req.businessData.description || "未提供数据描述"
  const qualityStr = req.businessData.quality === "high" ? "已治理" : "未治理"

  return `请对以下AI项目进行商业价值评估：

## 业务场景
${req.businessScenario}

## 技术方案
- 模型选择：${req.model}
- 硬件配置：${req.hardware} x ${req.cardCount}张
- 训练数据：${dataDescription}，数据质量：${qualityStr}
- 性能需求：TPS ${req.performanceRequirements.tps}，并发${req.performanceRequirements.concurrency}

## 评估要求

1. **严格禁止编造数据**：不要输出具体的金额、百分比、ROI数值等，除非用户明确提供
2. **段落式分析**：每个维度用连贯的段落进行深入分析，而非简单罗列
3. **平衡视角**：既要看到机会，也要识别风险
4. **可操作建议**：提供具体可执行的建议
5. **必须包含免责声明**

请直接输出JSON格式的评估结果，不要有任何其他文字。`
}

export async function evaluateBusinessValue(
  req: EvaluationRequest
): Promise<BusinessValueResult> {
  const apiKey = process.env.QIANFAN_API_KEY

  if (!apiKey) {
    throw new Error("QIANFAN_API_KEY 环境变量未设置")
  }

  const prompt = buildBusinessPrompt(req)

  console.log(`商业评估Prompt长度: ${prompt.length} 字符`)

  try {
    // 使用带重试的 fetch,增加重试次数和更长超时
    const response = await fetchWithRetry(
      "https://qianfan.baidubce.com/v2/chat/completions",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`,
          "X-Appbuilder-Authorization": apiKey, // IAM鉴权必需的header
        },
        body: JSON.stringify({
          model: "ernie-4.5-turbo-128k",
          messages: [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "system", content: FEW_SHOT_EXAMPLES },
            { role: "user", content: prompt },
          ],
          response_format: { type: "json_object" },
          temperature: 0.3,
        }),
      },
      {
        maxRetries: 6, // 增加到6次重试
        timeout: 180000, // 增加到180秒(3分钟)超时
        initialDelay: 3000,
        onRetry: (attempt, error) => {
          console.log(`商业价值评估API重试 (${attempt}/6):`, error.message)
        },
      }
    )

    const data = await response.json()

    // 检查千帆API的错误响应
    if (data.error_code || data.error_msg) {
      throw new Error(`千帆API错误: ${data.error_msg || data.error_code}`)
    }

    if (!data.choices?.[0]?.message?.content) {
      throw new Error("千帆API返回数据格式异常")
    }

    const result = JSON.parse(data.choices[0].message.content)
    return result
  } catch (error) {
    console.error("商业价值评估失败:", error)

    // 所有错误都直接抛出,不返回降级响应
    // 这样前端可以根据null判断是否显示该模块
    if (error instanceof Error) {
      throw error
    }
    throw new Error("商业价值评估服务暂时不可用，请稍后重试")
  }
}
